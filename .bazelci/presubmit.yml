---
matrix:
  workdir: [".", "rules_haskell_tests"]
  platform:
  - debian10
  - ubuntu2004
  - ubuntu1804
  # disable Windows for now, it fails with
  # "this rule is missing dependency declarations for the following files ..."
  #- windows
  bazel:
  - 6.x
  - last_green

tasks:
  ubuntu1804:
    working_directory: ${{ workdir }}
    platform: ${{ platform }}
    bazel: ${{ bazel }}
    environment:
      # haskell base uses the environment locale to decode sockets
      LANG: "C.UTF-8"
    shell_commands:
      - "sudo apt -y update && sudo apt -y install libgmp-dev"
    build_flags:
      - "--config=ci-common"
      - "--config=linux-bindist"
      - "--build_tag_filters=-requires_nix,-requires_lz4,-requires_shellcheck,-requires_threaded_rts,-dont_test_with_bindist,-dont_test_on_bazelci,-integration"
    build_targets:
      - "//tests/..."
    test_flags:
      - "--config=ci-common"
      - "--config=linux-bindist"
      - "--test_tag_filters=-requires_nix,-requires_lz4,-requires_shellcheck,-requires_threaded_rts,-dont_test_with_bindist,-dont_test_on_bazelci,-integration"
    test_targets:
      - "//tests/..."
